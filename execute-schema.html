<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Execute Database Schema - CRM Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #4299e1; }
        .progress {
            background: #e2e8f0;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ CRM Database Schema Setup</h1>
        
        <div class="form-group">
            <label for="supabaseUrl">Supabase URL:</label>
            <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co/rest/v1" required>
        </div>
        
        <div class="form-group">
            <label for="serviceKey">Service Role Key:</label>
            <input type="password" id="serviceKey" placeholder="Your service role key" required>
        </div>
        
        <button onclick="executeSchema()" id="executeBtn">
            ðŸ”§ Execute Database Schema
        </button>
        
        <div class="progress" id="progress" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="log" id="log" style="display: none;"></div>
    </div>

    <script>
        let supabase;
        let logElement;
        
        function log(message, type = 'info') {
            if (!logElement) {
                logElement = document.getElementById('log');
                logElement.style.display = 'block';
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            progress.style.display = 'block';
            progressBar.style.width = percent + '%';
        }
        
        async function executeSQL(sql, description) {
            try {
                log(`ðŸ”„ ${description}...`);
                
                // Try multiple approaches to execute SQL
                const approaches = [
                    // Approach 1: Direct table creation via Supabase client
                    async () => {
                        if (sql.includes('CREATE TABLE')) {
                            const tableName = sql.match(/CREATE TABLE (\w+)/i)?.[1];
                            if (tableName) {
                                // Try to query the table to see if it exists
                                const { data, error } = await supabase.from(tableName).select('*').limit(1);
                                if (!error) {
                                    return { success: true, message: 'Table already exists' };
                                }
                            }
                        }
                        throw new Error('Direct table creation not supported');
                    },
                    
                    // Approach 2: Use rpc if available
                    async () => {
                        const { data, error } = await supabase.rpc('exec_sql', { sql });
                        if (error) throw error;
                        return { success: true, data };
                    },
                    
                    // Approach 3: REST API call
                    async () => {
                        const response = await fetch(`${supabase.supabaseUrl}/rest/v1/rpc/exec_sql`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${supabase.supabaseKey}`,
                                'apikey': supabase.supabaseKey
                            },
                            body: JSON.stringify({ sql })
                        });
                        
                        if (!response.ok) {
                            const error = await response.text();
                            throw new Error(error);
                        }
                        
                        return { success: true };
                    }
                ];
                
                let lastError;
                for (const approach of approaches) {
                    try {
                        const result = await approach();
                        log(`âœ… ${description} - SUCCESS`, 'success');
                        return true;
                    } catch (error) {
                        lastError = error;
                        continue;
                    }
                }
                
                // If all approaches failed
                if (lastError.message.includes('already exists') || 
                    lastError.message.includes('duplicate')) {
                    log(`âš ï¸  ${description} - Already exists (OK)`, 'warning');
                    return true;
                } else {
                    log(`âŒ ${description} - ${lastError.message}`, 'error');
                    return false;
                }
                
            } catch (error) {
                if (error.message.includes('already exists') || 
                    error.message.includes('duplicate')) {
                    log(`âš ï¸  ${description} - Already exists (OK)`, 'warning');
                    return true;
                } else {
                    log(`âŒ ${description} - ${error.message}`, 'error');
                    return false;
                }
            }
        }
        
        async function createTablesDirectly() {
            log('ðŸ“‹ Creating tables using direct Supabase client methods...', 'info');
            
            // Since SQL execution isn't working, let's create a simple test user
            // and see if we can at least verify the connection
            try {
                // Test connection by trying to access auth
                const { data: { user }, error } = await supabase.auth.getUser();
                log('âœ… Supabase connection verified', 'success');
                
                // Try to create storage bucket
                const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
                if (!bucketsError) {
                    log('âœ… Storage access verified', 'success');
                    
                    const avatarsBucket = buckets.find(b => b.name === 'avatars');
                    if (!avatarsBucket) {
                        const { error: createError } = await supabase.storage.createBucket('avatars', {
                            public: true
                        });
                        if (!createError) {
                            log('âœ… Avatars bucket created', 'success');
                        }
                    } else {
                        log('âœ… Avatars bucket already exists', 'success');
                    }
                }
                
                return true;
            } catch (error) {
                log(`âŒ Connection test failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function executeSchema() {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const serviceKey = document.getElementById('serviceKey').value;
            const executeBtn = document.getElementById('executeBtn');
            
            if (!supabaseUrl || !serviceKey) {
                alert('Please fill in both Supabase URL and Service Role Key');
                return;
            }
            
            executeBtn.disabled = true;
            executeBtn.textContent = 'ðŸ”„ Executing...';
            
            // Clear previous logs
            document.getElementById('log').innerHTML = '';
            
            try {
                // Initialize Supabase client
                supabase = window.supabase.createClient(supabaseUrl, serviceKey);
                
                log('ðŸš€ SCHEMA EXECUTION STARTED', 'info');
                log(`ðŸ“¡ Target: ${supabaseUrl}`, 'info');
                
                updateProgress(10);
                
                // Test connection first
                const connectionOk = await createTablesDirectly();
                updateProgress(30);
                
                if (connectionOk) {
                    log('ðŸŽ‰ CONNECTION SUCCESSFUL!', 'success');
                    log('', 'info');
                    log('âš ï¸  MANUAL SETUP REQUIRED', 'warning');
                    log('Since automated SQL execution is not available, please:', 'info');
                    log('', 'info');
                    log('1. ðŸŒ Open your Supabase Dashboard:', 'info');
                    log(`   ${supabaseUrl.replace('/rest/v1', '')}`, 'info');
                    log('', 'info');
                    log('2. ðŸ“Š Go to SQL Editor', 'info');
                    log('', 'info');
                    log('3. ðŸ“‹ Copy and paste the contents of setup-database-schema.sql', 'info');
                    log('', 'info');
                    log('4. â–¶ï¸  Click "Run" to execute the SQL', 'info');
                    log('', 'info');
                    log('5. ðŸ”„ Refresh your CRM application', 'info');
                    log('', 'info');
                    log('ðŸ’¡ The SQL file contains all table definitions, indexes, and policies', 'info');
                    
                    updateProgress(100);
                    
                    // Auto-open Supabase dashboard
                    setTimeout(() => {
                        const dashboardUrl = supabaseUrl.replace('/rest/v1', '') + '/sql';
                        window.open(dashboardUrl, '_blank');
                        log('ðŸŒ Opening Supabase SQL Editor...', 'info');
                    }, 2000);
                    
                } else {
                    log('âŒ CONNECTION FAILED', 'error');
                    log('Please check your Supabase URL and Service Role Key', 'error');
                    updateProgress(0);
                }
                
            } catch (error) {
                log(`âŒ Setup failed: ${error.message}`, 'error');
                updateProgress(0);
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = 'ðŸ”§ Execute Database Schema';
            }
        }
        
        // Auto-fill from environment if available
        window.addEventListener('load', () => {
            // These would be filled by a script if available
            const urlInput = document.getElementById('supabaseUrl');
            const keyInput = document.getElementById('serviceKey');
            
            // Try to get from URL parameters (if passed by a script)
            const params = new URLSearchParams(window.location.search);
            if (params.get('url')) urlInput.value = params.get('url');
            if (params.get('key')) keyInput.value = params.get('key');
        });
    </script>
</body>
</html>