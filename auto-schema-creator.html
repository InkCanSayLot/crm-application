
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Schema Creator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .progress { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ðŸš€ Automated Database Schema Creator</h1>
    
    <div class="info">
        <strong>Auto-Configuration Detected!</strong><br>
        Supabase URL: https://kifvxrjpvkoilzxuehci.supabase.co<br>
        Service Key: Ready âœ…
    </div>
    
    <button id="createBtn" onclick="createSchema()">ðŸ”§ Create Database Schema Automatically</button>
    
    <div id="status"></div>
    <div id="log"></div>

    <script>
        const SUPABASE_URL = 'https://kifvxrjpvkoilzxuehci.supabase.co';
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpZnZ4cmpwdmtvaWx6eHVlaGNpIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTg0OTIzMSwiZXhwIjoyMDc3NDI1MjMxfQ.IMtX9cj322IDR-D3wDJwG1vbTHOST7ZKVzSJktx-6qs';
        
        let supabase;
        let logElement;
        
        function log(message, type = 'info') {
            console.log(message);
            if (logElement) {
                const timestamp = new Date().toLocaleTimeString();
                logElement.textContent += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
            }
        }
        
        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }
        
        async function createSchema() {
            logElement = document.getElementById('log');
            const btn = document.getElementById('createBtn');
            
            btn.disabled = true;
            btn.textContent = 'ðŸ”„ Creating Schema...';
            
            try {
                log('ðŸš€ Starting automated schema creation...');
                setStatus('ðŸ”„ Initializing Supabase client...', 'progress');
                
                // Initialize Supabase client
                supabase = supabase.createClient(SUPABASE_URL, SERVICE_KEY, {
                    auth: { autoRefreshToken: false, persistSession: false }
                });
                
                log('âœ… Supabase client initialized');
                
                // Test connection
                setStatus('ðŸ”„ Testing connection...', 'progress');
                log('ðŸ”Œ Testing connection...');
                
                const { data: testData, error: testError } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (testError && !testError.message.includes('does not exist')) {
                    throw new Error(`Connection failed: ${testError.message}`);
                }
                
                log('âœ… Connection successful');
                
                // Create schema using the comprehensive SQL
                setStatus('ðŸ”„ Creating database schema...', 'progress');
                log('ðŸ“‹ Creating database tables...');
                
                const schemaSQL = `
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create users table
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email TEXT UNIQUE NOT NULL,
    full_name TEXT,
    avatar_url TEXT,
    role TEXT DEFAULT 'user',
    is_online BOOLEAN DEFAULT false,
    last_seen TIMESTAMPTZ DEFAULT now(),
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create clients table
CREATE TABLE IF NOT EXISTS clients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    email TEXT,
    phone TEXT,
    company TEXT,
    status TEXT DEFAULT 'active',
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create tasks table
CREATE TABLE IF NOT EXISTS tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    status TEXT DEFAULT 'pending',
    priority TEXT DEFAULT 'medium',
    due_date TIMESTAMPTZ,
    client_id UUID REFERENCES clients(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create calendar_events table
CREATE TABLE IF NOT EXISTS calendar_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    client_id UUID REFERENCES clients(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create journal_entries table
CREATE TABLE IF NOT EXISTS journal_entries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    mood TEXT,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create chat_rooms table
CREATE TABLE IF NOT EXISTS chat_rooms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    is_private BOOLEAN DEFAULT false,
    created_by UUID REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create chat_messages table
CREATE TABLE IF NOT EXISTS chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID REFERENCES chat_rooms(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    message_type TEXT DEFAULT 'text',
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Create task_groups table
CREATE TABLE IF NOT EXISTS task_groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    color TEXT DEFAULT 'blue',
    created_by UUID REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_clients_user_id ON clients(user_id);
CREATE INDEX IF NOT EXISTS idx_tasks_user_id ON tasks(user_id);
CREATE INDEX IF NOT EXISTS idx_tasks_client_id ON tasks(client_id);
CREATE INDEX IF NOT EXISTS idx_calendar_events_user_id ON calendar_events(user_id);
CREATE INDEX IF NOT EXISTS idx_journal_entries_user_id ON journal_entries(user_id);
CREATE INDEX IF NOT EXISTS idx_chat_messages_room_id ON chat_messages(room_id);
CREATE INDEX IF NOT EXISTS idx_chat_messages_user_id ON chat_messages(user_id);

-- Enable RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE calendar_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE journal_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE task_groups ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
CREATE POLICY IF NOT EXISTS "Users can view their own data" ON users FOR SELECT USING (auth.uid() = id);
CREATE POLICY IF NOT EXISTS "Users can update their own data" ON users FOR UPDATE USING (auth.uid() = id);

CREATE POLICY IF NOT EXISTS "Users can view their own clients" ON clients FOR ALL USING (auth.uid() = user_id);
CREATE POLICY IF NOT EXISTS "Users can view their own tasks" ON tasks FOR ALL USING (auth.uid() = user_id);
CREATE POLICY IF NOT EXISTS "Users can view their own calendar events" ON calendar_events FOR ALL USING (auth.uid() = user_id);
CREATE POLICY IF NOT EXISTS "Users can view their own journal entries" ON journal_entries FOR ALL USING (auth.uid() = user_id);

CREATE POLICY IF NOT EXISTS "Users can view all chat rooms" ON chat_rooms FOR SELECT USING (true);
CREATE POLICY IF NOT EXISTS "Users can view all chat messages" ON chat_messages FOR SELECT USING (true);
CREATE POLICY IF NOT EXISTS "Users can insert chat messages" ON chat_messages FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY IF NOT EXISTS "Users can view all task groups" ON task_groups FOR SELECT USING (true);
CREATE POLICY IF NOT EXISTS "Users can manage their own task groups" ON task_groups FOR ALL USING (auth.uid() = created_by);

-- Insert initial data
INSERT INTO users (id, email, full_name, role) VALUES 
('00000000-0000-0000-0000-000000000001', 'demo@example.com', 'Demo User', 'admin')
ON CONFLICT (id) DO NOTHING;

INSERT INTO chat_rooms (id, name, description, created_by) VALUES 
('00000000-0000-0000-0000-000000000001', 'General', 'General discussion room', '00000000-0000-0000-0000-000000000001')
ON CONFLICT (id) DO NOTHING;
`;
                
                // Execute SQL using RPC
                try {
                    const { data, error } = await supabase.rpc('exec_sql', { sql: schemaSQL });
                    if (error) {
                        log(`âš ï¸  RPC execution note: ${error.message}`);
                    } else {
                        log('âœ… Schema created via RPC');
                    }
                } catch (rpcError) {
                    log(`âš ï¸  RPC method not available: ${rpcError.message}`);
                }
                
                // Verify tables were created
                setStatus('ðŸ”„ Verifying schema...', 'progress');
                log('ðŸ” Verifying created tables...');
                
                const tables = ['users', 'clients', 'tasks', 'calendar_events', 'journal_entries', 'chat_rooms', 'chat_messages', 'task_groups'];
                let verifiedTables = 0;
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase.from(table).select('count').limit(1);
                        if (!error) {
                            log(`âœ… Table '${table}' verified`);
                            verifiedTables++;
                        } else {
                            log(`âŒ Table '${table}' not accessible: ${error.message}`);
                        }
                    } catch (err) {
                        log(`âŒ Table '${table}' error: ${err.message}`);
                    }
                }
                
                // Create storage bucket
                log('ðŸ—„ï¸  Setting up storage...');
                try {
                    const { data: buckets } = await supabase.storage.listBuckets();
                    const avatarsBucket = buckets?.find(b => b.name === 'avatars');
                    
                    if (!avatarsBucket) {
                        const { error: createError } = await supabase.storage.createBucket('avatars', { public: true });
                        if (!createError || createError.message.includes('already exists')) {
                            log('âœ… Created avatars storage bucket');
                        } else {
                            log(`âš ï¸  Storage bucket creation: ${createError.message}`);
                        }
                    } else {
                        log('âœ… Avatars storage bucket already exists');
                    }
                } catch (storageError) {
                    log(`âš ï¸  Storage setup: ${storageError.message}`);
                }
                
                if (verifiedTables >= tables.length * 0.8) {
                    setStatus(`ðŸŽ‰ Schema creation completed! ${verifiedTables}/${tables.length} tables verified`, 'success');
                    log(`ðŸŽ‰ Schema creation completed successfully!`);
                    log(`ðŸ“Š ${verifiedTables}/${tables.length} tables verified`);
                    log('âœ… Database is ready for data import');
                    
                    btn.textContent = 'âœ… Schema Created Successfully!';
                    btn.style.background = '#28a745';
                } else {
                    setStatus(`âš ï¸  Schema partially created. ${verifiedTables}/${tables.length} tables verified`, 'error');
                    log(`âš ï¸  Only ${verifiedTables}/${tables.length} tables were verified`);
                    log('ðŸ“‹ You may need to run the SQL manually in Supabase dashboard');
                    
                    btn.textContent = 'âš ï¸  Partial Success';
                    btn.style.background = '#ffc107';
                    btn.disabled = false;
                }
                
            } catch (error) {
                log(`âŒ Schema creation failed: ${error.message}`);
                setStatus(`âŒ Schema creation failed: ${error.message}`, 'error');
                
                btn.textContent = 'âŒ Creation Failed - Retry';
                btn.style.background = '#dc3545';
                btn.disabled = false;
            }
        }
        
        // Auto-start the process after page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ðŸ¤– Auto-starting schema creation in 2 seconds...');
                setTimeout(createSchema, 2000);
            }, 1000);
        });
    </script>
</body>
</html>
